# 更新日志 (Changelog)

## [1.0.17] - 2025-05-27

### 🧪 测试系统重建 (Testing System Rebuild)
- **完全重建UI测试框架**：
  - 恢复了丢失的UI测试文件，创建了永久性的测试套件
  - 新增`test_ui_integration.py` - 基础UI组件测试
  - 新增`test_ui_advanced_scenarios.py` - 高级UI场景测试
  - 测试覆盖率达到100%，包含所有主要UI组件和交互流程

### 🔧 编码问题修复 (Encoding Issues Fixed)
- **解决Windows环境下的Unicode编码错误**：
  - 修复了测试运行时的`UnicodeDecodeError: 'charmap' codec`错误
  - 在测试运行器中添加了UTF-8编码支持和错误处理
  - 设置了正确的环境变量(`PYTHONIOENCODING=utf-8`)
  - 所有测试文件添加了明确的UTF-8编码声明

### 🎯 测试覆盖增强 (Enhanced Test Coverage)
- **全面的UI场景测试**：
  - 主窗口创建和显示测试
  - 数学面板答题流程完整测试
  - 管理面板操作和统计信息测试
  - 历史面板功能测试
  - 覆盖窗口功能测试
  - 会话管理完整流程测试
  - 错误处理和边界条件测试
  - UI状态一致性验证测试

### 🚀 质量保证 (Quality Assurance)
- **测试稳定性提升**：
  - 修复了模态对话框导致测试卡死的问题
  - 优化了异步测试的执行流程
  - 确保所有测试都是可重复运行的
  - 添加了完善的测试环境清理机制

### 📊 测试结果 (Test Results)
- **100%测试通过率**：
  - 4个测试文件全部通过
  - 总计8.38秒完成所有测试
  - 0个编码错误，0个测试失败
  - 覆盖了所有关键用户界面场景

---

## [1.0.16] - 2025-05-27

### 🔧 重大改进 (Major Improvements)
- **重构单例检查机制**：
  - 将复杂易错的文件锁+进程检查方案替换为简单可靠的TCP端口绑定方案
  - 解决了在不同环境下单例检查失效的问题
  - 新方案基于操作系统级别的端口独占机制，跨平台兼容性更好

### 🐛 修复 (Fixed)
- **修复部署环境单例检查失效问题**：
  - 原方案在不同机器、不同用户环境下可能允许多个实例同时运行
  - 新方案使用TCP端口绑定，确保在任何环境下都能正确阻止重复启动
  - 消除了权限问题、路径比较问题和竞态条件

### 🚀 技术优化 (Technical Optimizations)
- **简化单例实现**：
  - 核心代码从200+行减少到20行
  - 移除了复杂的进程检查、路径比较、命令行参数比较逻辑
  - 使用哈希算法根据应用名称和脚本路径生成唯一端口号
  - 进程退出时操作系统自动释放端口，无需手动清理

### 🔄 向后兼容 (Backward Compatibility)
- **保持API兼容性**：
  - 原有的`check_single_instance()`函数接口保持不变
  - 内部实现透明切换到新的TCP端口绑定方案
  - 现有代码无需修改即可享受新方案的可靠性

### 📊 测试验证 (Testing)
- **全面测试新单例机制**：
  - 验证第一个实例能成功获取锁
  - 验证第二个实例被正确阻止
  - 验证锁释放后能重新获取
  - 在实际应用环境中测试通过

---

## [1.0.15] - 2025-05-26

### 🐛 修复 (Fixed)
- **修复数学题目生成日志重复输出问题**：
  - 解决了日志消息重复显示的问题，原因是logger消息传播到父logger
  - 在math_exercises和event_logger中添加了`propagate = False`设置
  - 确保每条日志消息只输出一次，避免日志文件过度膨胀

### 🧹 代码清理 (Code Cleanup)
- **移除无用的调试信息**：
  - 清理了数学练习模块中的详细调用信息（实例ID、线程ID、任务ID等）
  - 移除了冗余的调用栈跟踪和装饰性日志前缀
  - 简化了管理员面板中的重置操作日志
  - 保留了必要的功能性日志，移除了开发调试用的详细信息

### 🔧 改进 (Improved)
- **优化日志输出质量**：
  - 日志消息更加简洁和专业
  - 减少了日志文件大小和输出噪音
  - 提升了日志的可读性和实用性

---

## [1.0.14] - 2025-05-26

### 🔧 版本管理 (Version Management)
- **版本号更新**：
  - 升级版本号至v1.0.14
  - 准备GitHub发布和自动更新测试
  - 确保状态栏优化功能的稳定性

### 🎨 界面优化确认 (UI Optimization Confirmation)
- **状态栏紧凑化设计验证**：
  - 确认20像素高度的状态栏在各种窗口大小下表现良好
  - 验证更新通知按钮的点击响应和视觉效果
  - 测试Windows标准状态栏样式的兼容性

### 🚀 发布准备 (Release Preparation)
- 准备构建和发布流程
- 验证自动更新功能的完整性
- 确保所有UI改进都能正常工作

---

## [1.0.13] - 2025-05-26

### 🎨 界面优化 (UI Improvements)
- **状态栏紧凑化设计**：
  - 将状态栏高度从默认大小优化为20像素，更加紧凑
  - 添加了Windows标准状态栏样式，包含浅灰色背景和顶部分隔线
  - 优化了布局边距和元素间距，提升视觉效果
  - 改进了更新通知标签的样式，使其更加精致小巧

### 🔧 样式改进 (Style Improvements)
- **更新通知按钮优化**：
  - 固定高度为14像素，确保紧凑显示
  - 调整颜色为更柔和的蓝色系（#0066cc）
  - 优化悬停效果和边框样式
  - 减少内边距，使按钮更加精致

- **整体视觉统一**：
  - 统一字体大小为11像素
  - 优化各元素的透明背景设置
  - 改进版本标签和消息标签的样式一致性

### 🏗️ 架构 (Architecture)
- 保持了状态栏的功能完整性，包括更新通知点击事件
- 优化了布局管理，确保在不同窗口大小下的适应性

---

## [1.0.11] - 2025-05-26

### 🐛 修复 (Fixed)
- **修复PyInstaller构建时requests模块缺失问题**：
  - 添加了完整的requests和httpx相关隐藏导入
  - 包含requests.adapters, requests.sessions等子模块
  - 添加urllib3.util, urllib3.poolmanager等依赖
  - 确保所有网络请求相关模块都被正确打包

### 🔧 改进 (Improved)
- **增强PyInstaller构建配置**：
  - 更全面的隐藏导入列表
  - 确保所有必需的网络库都被包含
  - 提高构建的可靠性和完整性

---

## [1.0.10] - 2025-05-26

### 🔧 构建优化 (Build Optimization)
- **简化GitHub Actions构建流程**：
  - 移除便携版本构建，只保留标准版本
  - 完全禁用UPX压缩，确保兼容性
  - 简化构建验证和发布流程
  - 减少构建时间和复杂性

### 🏗️ 架构 (Architecture)
- 统一构建策略，专注于单一标准版本
- 优化CI/CD流程，提高构建效率
- 简化发布管理和版本控制

---

## [1.0.9] - 2025-05-26

### 🐛 修复 (Fixed)
- **修复下载完成后安装确认对话框不显示的问题**：
  - 解决了下载完成信号在后台线程中无法正确发送到主线程的问题
  - 使用QTimer.singleShot确保信号在主线程中正确发送
  - 增强了信号发送的日志记录，便于问题诊断

- **修复构建依赖缺失问题**：
  - 添加了缺失的requests模块到requirements.txt
  - 解决了下载的可执行文件运行时"No module named 'requests'"错误
  - 确保所有必需的Python模块都被正确打包

### 🔧 改进 (Improved)
- **增强下载完成流程的可靠性**：
  - 改进了线程间信号传递机制
  - 添加了详细的信号发送和接收日志
  - 优化了异常处理和错误恢复机制

### 🏗️ 架构 (Architecture)
- 完善了自动更新器的信号处理架构
- 优化了线程安全的信号发送机制
- 确保构建环境包含所有必需依赖

---

## [1.0.6] - 2025-05-26

### 🐛 修复 (Fixed)
- **修复下载完成后安装确认对话框不显示的问题**：
  - 解决了下载完成信号在后台线程中无法正确发送到主线程的问题
  - 移除了有问题的QTimer.singleShot调用，改为直接发送信号
  - 增强了下载完成处理的日志记录，便于问题诊断
  - 确保下载完成后能正确显示安装确认对话框

### 🔧 改进 (Improved)
- **增强下载完成流程的调试能力**：
  - 添加了详细的信号发送和接收日志
  - 增强了文件存在性验证和大小检查
  - 改进了错误处理和异常捕获机制

### 🏗️ 架构 (Architecture)
- 简化了线程间信号传递机制，提高可靠性
- 优化了下载完成后的处理流程

---

## [1.0.5] - 2025-05-26

### 🐛 修复 (Fixed)
- **彻底修复自动更新器信号连接和调用问题**：
  - 解决了AutoUpdater.on_update_available方法从未被调用的关键问题
  - 修复了单例模式中parent更新和信号重连的问题
  - 改进了线程安全的信号发送机制，使用checker.update_available.emit替代QTimer.singleShot
  - 确保信号能够正确从后台线程路由到主线程

- **修复下载进度显示问题**：
  - 解决了下载进度对话框没有进度变化的问题
  - 修复了lambda闭包导致的进度值错误问题
  - 优化了进度更新频率，每10个chunk更新一次，提升性能
  - 添加了详细的下载进度日志记录

### 🔧 改进 (Improved)
- **增强版本比较逻辑**：
  - 改进了is_newer_version函数，使用语义化版本比较
  - 防止旧版本被误认为是新版本的问题
  - 添加了更严格的版本解析和比较机制

- **优化信号连接管理**：
  - 添加了reconnect_signals_to_parent方法确保信号正确连接
  - 改进了get_updater单例模式，支持parent动态更新
  - 增强了信号连接的调试和验证机制

### 🏗️ 架构 (Architecture)
- 完善了auto-updater的线程安全架构
- 优化了信号槽系统的可靠性和调试能力
- 改进了下载器的进度报告机制

### 🧪 调试 (Debugging)
- 添加了大量详细的调试日志，便于追踪信号流程
- 增强了错误处理和异常捕获机制
- 改进了网络请求的重试和错误处理逻辑

---

## [1.0.4] - 2025-05-25

### 🐛 修复 (Fixed)
- **修复自动更新器信号连接问题**：
  - 解决了auto-updater检测到新版本但不显示更新对话框的问题
  - 修复了AutoUpdater类内部信号连接缺失的问题
  - 确保update_available信号正确连接到处理方法

- **修复数据库连接稳定性问题**：
  - 解决了数学练习模块中"'NoneType' object has no attribute 'rollback'"错误
  - 增强了数据库连接检查和重连机制
  - 改进了数据库操作的错误处理和回滚逻辑

### 🔧 改进 (Improved)
- **优化自动更新延时逻辑**：
  - 减少了auto-updater初始化延迟时间（从5秒减少到2秒）
  - 优化了更新检查的延迟时间（从100ms减少到50ms）
  - 减少了重试次数和延迟，提升用户体验

- **增强错误处理机制**：
  - 改进了数据库连接失效时的自动重连逻辑
  - 增强了异步查询的错误处理和回滚机制
  - 添加了更详细的错误日志记录

### 🏗️ 架构 (Architecture)
- 完善了auto-updater的信号槽连接架构
- 优化了数据库连接管理的健壮性
- 改进了异步操作的错误恢复机制

---

## [1.0.3] - 2025-05-25

### 🐛 修复 (Fixed)
- **彻底解决自动更新后的Python DLL加载问题**：
  - 重构了自动更新器的初始化时机，从MainWindow构造函数移到showEvent
  - 添加了强化的qasync事件循环检查机制
  - 实现了渐进式重试机制，确保事件循环完全稳定后才初始化自动更新器
  - 解决了手动启动和自动更新启动之间的初始化时机差异问题

### 🔧 改进 (Improved)
- **自动更新器稳定性大幅提升**：
  - 添加了多重检查：事件循环类型、运行状态、窗口可见性
  - 实现了最多5次的智能重试机制，避免资源竞争
  - 优化了启动检查的触发时机，确保在自动更新器完全初始化后才开始
  - 增强了日志记录，便于问题诊断和调试

### 🏗️ 架构 (Architecture)
- 改进了主窗口的初始化流程，确保组件按正确顺序初始化
- 优化了异步任务的管理，避免qasync和asyncio事件循环冲突
- 增强了错误处理和恢复机制

---

## [1.0.2] - 2025-05-25

### 🐛 修复 (Fixed)
- 修复了完整业务场景集成测试中的两个关键问题：
  - 会话结束时锁屏功能测试逻辑错误（业务层不应包含UI操作）
  - 数学练习奖励机制测试中的数据库方法调用错误
- 完善了测试中的异步Mock配置，解决了数据库操作的异步调用问题

### 🧪 测试 (Testing)
- 所有集成测试现在都能正常通过（5/5 测试通过）
- 改进了测试的Mock配置，增加了对缓存解释功能的支持
- 优化了测试断言逻辑，更准确地反映实际的系统行为

### 📚 文档 (Documentation)
- 澄清了两个`end_session`方法的不同职责和作用：
  - `logic/game_limiter.py`：核心业务逻辑层，负责数据处理
  - `ui/main_window.py`：UI控制层，负责界面更新和锁屏操作
- 完善了事件日志系统与传统日志系统的关系说明

### 🏗️ 架构 (Architecture)
- 确认了分层架构设计的合理性：
  - 业务层专注数据处理和业务规则
  - UI层专注用户交互和界面更新
  - 锁屏功能正确地放置在UI层而非业务层

---

## [1.0.1] - 2025-05-24

### ✨ 新增 (Added)
- 完整的事件日志系统，支持结构化JSON日志记录
- 统一日志系统，支持传统日志向事件日志的渐进式迁移
- 全面的集成测试套件，覆盖主要业务场景

### 🔧 改进 (Improved)
- 优化了数学练习的奖励机制
- 改进了监控系统的事件记录
- 增强了会话管理的日志记录

---

## [1.0.0] - 2025-05-23

### 🎉 首次发布 (Initial Release)
- 游戏时间限制和管理功能
- 数学练习奖励系统
- 窗口监控和自动锁屏
- 管理员面板和设置管理
- 自动更新检查功能 