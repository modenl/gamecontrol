# 更新日志 (Changelog)

## [1.0.9] - 2025-05-26

### 🐛 修复 (Fixed)
- **修复下载完成后安装确认对话框不显示的问题**：
  - 解决了下载完成信号在后台线程中无法正确发送到主线程的问题
  - 使用QTimer.singleShot确保信号在主线程中正确发送
  - 增强了信号发送的日志记录，便于问题诊断

- **修复构建依赖缺失问题**：
  - 添加了缺失的requests模块到requirements.txt
  - 解决了下载的可执行文件运行时"No module named 'requests'"错误
  - 确保所有必需的Python模块都被正确打包

### 🔧 改进 (Improved)
- **增强下载完成流程的可靠性**：
  - 改进了线程间信号传递机制
  - 添加了详细的信号发送和接收日志
  - 优化了异常处理和错误恢复机制

### 🏗️ 架构 (Architecture)
- 完善了自动更新器的信号处理架构
- 优化了线程安全的信号发送机制
- 确保构建环境包含所有必需依赖

---

## [1.0.6] - 2025-05-26

### 🐛 修复 (Fixed)
- **修复下载完成后安装确认对话框不显示的问题**：
  - 解决了下载完成信号在后台线程中无法正确发送到主线程的问题
  - 移除了有问题的QTimer.singleShot调用，改为直接发送信号
  - 增强了下载完成处理的日志记录，便于问题诊断
  - 确保下载完成后能正确显示安装确认对话框

### 🔧 改进 (Improved)
- **增强下载完成流程的调试能力**：
  - 添加了详细的信号发送和接收日志
  - 增强了文件存在性验证和大小检查
  - 改进了错误处理和异常捕获机制

### 🏗️ 架构 (Architecture)
- 简化了线程间信号传递机制，提高可靠性
- 优化了下载完成后的处理流程

---

## [1.0.5] - 2025-05-26

### 🐛 修复 (Fixed)
- **彻底修复自动更新器信号连接和调用问题**：
  - 解决了AutoUpdater.on_update_available方法从未被调用的关键问题
  - 修复了单例模式中parent更新和信号重连的问题
  - 改进了线程安全的信号发送机制，使用checker.update_available.emit替代QTimer.singleShot
  - 确保信号能够正确从后台线程路由到主线程

- **修复下载进度显示问题**：
  - 解决了下载进度对话框没有进度变化的问题
  - 修复了lambda闭包导致的进度值错误问题
  - 优化了进度更新频率，每10个chunk更新一次，提升性能
  - 添加了详细的下载进度日志记录

### 🔧 改进 (Improved)
- **增强版本比较逻辑**：
  - 改进了is_newer_version函数，使用语义化版本比较
  - 防止旧版本被误认为是新版本的问题
  - 添加了更严格的版本解析和比较机制

- **优化信号连接管理**：
  - 添加了reconnect_signals_to_parent方法确保信号正确连接
  - 改进了get_updater单例模式，支持parent动态更新
  - 增强了信号连接的调试和验证机制

### 🏗️ 架构 (Architecture)
- 完善了auto-updater的线程安全架构
- 优化了信号槽系统的可靠性和调试能力
- 改进了下载器的进度报告机制

### 🧪 调试 (Debugging)
- 添加了大量详细的调试日志，便于追踪信号流程
- 增强了错误处理和异常捕获机制
- 改进了网络请求的重试和错误处理逻辑

---

## [1.0.4] - 2025-05-25

### 🐛 修复 (Fixed)
- **修复自动更新器信号连接问题**：
  - 解决了auto-updater检测到新版本但不显示更新对话框的问题
  - 修复了AutoUpdater类内部信号连接缺失的问题
  - 确保update_available信号正确连接到处理方法

- **修复数据库连接稳定性问题**：
  - 解决了数学练习模块中"'NoneType' object has no attribute 'rollback'"错误
  - 增强了数据库连接检查和重连机制
  - 改进了数据库操作的错误处理和回滚逻辑

### 🔧 改进 (Improved)
- **优化自动更新延时逻辑**：
  - 减少了auto-updater初始化延迟时间（从5秒减少到2秒）
  - 优化了更新检查的延迟时间（从100ms减少到50ms）
  - 减少了重试次数和延迟，提升用户体验

- **增强错误处理机制**：
  - 改进了数据库连接失效时的自动重连逻辑
  - 增强了异步查询的错误处理和回滚机制
  - 添加了更详细的错误日志记录

### 🏗️ 架构 (Architecture)
- 完善了auto-updater的信号槽连接架构
- 优化了数据库连接管理的健壮性
- 改进了异步操作的错误恢复机制

---

## [1.0.3] - 2025-05-25

### 🐛 修复 (Fixed)
- **彻底解决自动更新后的Python DLL加载问题**：
  - 重构了自动更新器的初始化时机，从MainWindow构造函数移到showEvent
  - 添加了强化的qasync事件循环检查机制
  - 实现了渐进式重试机制，确保事件循环完全稳定后才初始化自动更新器
  - 解决了手动启动和自动更新启动之间的初始化时机差异问题

### 🔧 改进 (Improved)
- **自动更新器稳定性大幅提升**：
  - 添加了多重检查：事件循环类型、运行状态、窗口可见性
  - 实现了最多5次的智能重试机制，避免资源竞争
  - 优化了启动检查的触发时机，确保在自动更新器完全初始化后才开始
  - 增强了日志记录，便于问题诊断和调试

### 🏗️ 架构 (Architecture)
- 改进了主窗口的初始化流程，确保组件按正确顺序初始化
- 优化了异步任务的管理，避免qasync和asyncio事件循环冲突
- 增强了错误处理和恢复机制

---

## [1.0.2] - 2025-05-25

### 🐛 修复 (Fixed)
- 修复了完整业务场景集成测试中的两个关键问题：
  - 会话结束时锁屏功能测试逻辑错误（业务层不应包含UI操作）
  - 数学练习奖励机制测试中的数据库方法调用错误
- 完善了测试中的异步Mock配置，解决了数据库操作的异步调用问题

### 🧪 测试 (Testing)
- 所有集成测试现在都能正常通过（5/5 测试通过）
- 改进了测试的Mock配置，增加了对缓存解释功能的支持
- 优化了测试断言逻辑，更准确地反映实际的系统行为

### 📚 文档 (Documentation)
- 澄清了两个`end_session`方法的不同职责和作用：
  - `logic/game_limiter.py`：核心业务逻辑层，负责数据处理
  - `ui/main_window.py`：UI控制层，负责界面更新和锁屏操作
- 完善了事件日志系统与传统日志系统的关系说明

### 🏗️ 架构 (Architecture)
- 确认了分层架构设计的合理性：
  - 业务层专注数据处理和业务规则
  - UI层专注用户交互和界面更新
  - 锁屏功能正确地放置在UI层而非业务层

---

## [1.0.1] - 2025-05-24

### ✨ 新增 (Added)
- 完整的事件日志系统，支持结构化JSON日志记录
- 统一日志系统，支持传统日志向事件日志的渐进式迁移
- 全面的集成测试套件，覆盖主要业务场景

### 🔧 改进 (Improved)
- 优化了数学练习的奖励机制
- 改进了监控系统的事件记录
- 增强了会话管理的日志记录

---

## [1.0.0] - 2025-05-23

### 🎉 首次发布 (Initial Release)
- 游戏时间限制和管理功能
- 数学练习奖励系统
- 窗口监控和自动锁屏
- 管理员面板和设置管理
- 自动更新检查功能 