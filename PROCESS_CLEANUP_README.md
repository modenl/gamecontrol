# GameTimeLimiter 进程清理指南

## 问题描述

在某些情况下，GameTimeLimiter 应用关闭后可能会有进程残留，这通常是由于以下原因：

1. **异步任务未正确取消** - 窗口监控、数据库操作等异步任务可能没有完全停止
2. **数据库连接未关闭** - SQLite 连接可能仍然保持打开状态
3. **子进程未清理** - Python 子进程或相关的系统进程可能仍在运行
4. **事件循环未停止** - asyncio 事件循环可能没有正确关闭

## 解决方案

### 1. 改进的应用清理机制

我们已经改进了应用的资源清理机制：

- **同步停止监控** - 在应用退出时同步停止窗口监控任务
- **强制任务取消** - 取消所有未完成的异步任务
- **数据库连接清理** - 确保数据库连接被正确关闭
- **子进程清理** - 自动终止所有子进程
- **强制退出机制** - 最后使用系统信号强制退出

### 2. 进程清理工具

#### 手动检查进程
```bash
# 检查是否有残留进程
python cleanup_processes.py
```

#### 交互式清理
```bash
# 检查并询问是否清理进程
python cleanup_processes.py --kill
```

#### 自动清理
```bash
# 自动清理进程和临时文件
python cleanup_processes.py --auto --kill --clean-temp
```

### 3. 批处理文件

#### 简单检查
双击运行 `cleanup.bat` - 检查残留进程但不自动清理

#### 自动清理
双击运行 `cleanup_auto.bat` - 自动清理所有残留进程和临时文件

## 使用建议

### 正常关闭应用
1. 使用应用内的关闭按钮
2. 输入管理员密码确认关闭
3. 等待应用完全退出

### 如果发现进程残留
1. 首先尝试运行 `cleanup.bat` 检查情况
2. 如果确认有残留进程，运行 `cleanup_auto.bat` 自动清理
3. 或者手动运行清理命令：
   ```bash
   python cleanup_processes.py --auto --kill
   ```

### 预防措施
1. **避免强制关闭** - 不要使用任务管理器强制结束进程
2. **等待完全退出** - 关闭应用后等待几秒钟确保完全退出
3. **定期清理** - 可以定期运行清理工具检查系统状态

## 清理工具功能

### 进程检测
- 检测所有相关的 Python 进程
- 识别 GameTimeLimiter 相关的进程
- 显示进程详细信息（PID、名称、创建时间、命令行）

### 进程清理
- 优雅终止进程（SIGTERM）
- 强制杀死顽固进程（SIGKILL）
- 递归清理子进程

### 临时文件清理
- 清理日志文件（*.log）
- 清理临时文件（*.tmp）
- 清理 Python 缓存（__pycache__、*.pyc）

## 故障排除

### 如果清理工具无法运行
```bash
# 确保 Python 环境正确
python --version

# 检查依赖包
pip install psutil
```

### 如果进程无法终止
1. 以管理员权限运行清理工具
2. 使用任务管理器手动结束进程
3. 重启计算机（最后手段）

### 如果问题持续存在
1. 检查应用日志文件 `app.log`
2. 运行清理工具的详细模式
3. 联系技术支持

## 技术细节

### 改进的清理机制
1. **分步骤清理** - 按优先级顺序清理不同类型的资源
2. **超时机制** - 为异步任务设置超时，避免无限等待
3. **强制退出** - 最后使用系统信号确保进程退出
4. **错误处理** - 每个清理步骤都有独立的错误处理

### 进程识别算法
1. **进程名匹配** - 检查进程名是否包含相关关键词
2. **命令行分析** - 分析命令行参数确定关联性
3. **工作目录检查** - 检查进程的工作目录
4. **父子关系** - 识别相关的子进程

这些改进应该能够有效解决进程残留问题。如果问题仍然存在，请运行清理工具并查看详细日志。 